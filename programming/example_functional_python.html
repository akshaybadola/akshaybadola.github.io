<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta name="generator" content="pandoc" />
     <meta name="author" content="Akshay Badola" /> 
     <meta name="date" content="2020-06-09" /> 

    <!-- Perhaps change this to something else?     -->
    <title>Python Functional Programming Example</title>
    <style type="text/css">code{white-space: pre;}</style>

    <!-- What's this? Quotes?-->
    

    <!-- highlighting must add -->
     <style type="text/css"> pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */ </style> 

    <!--Custom CSS styles. Should be more elegant but... -->
    <!--Maybe I can put a for loop here-->
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap-responsive.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/style.css"/>
    <!--End -->

    
    

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
      extensions: ["tex2jax.js"],
      jax: ["input/TeX","output/HTML-CSS"],
      tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]}});
    </script>
    <script type="text/javascript" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js">
    </script>
    <script type="text/javascript"
            src="../assets/js/backref.js">
    </script>

  </head>
  <body>
    <div class="banner">
      <!-- Title -->
       <div id="header" align="center"> <h1 class="title">void *ptr</h1>
	
	
      </div>
    </div>
    <script type="text/javascript" src="../assets/js/programming_titles.js"></script>
    <!-- Other custom includes? Before?-->
    

    <div class="menu-container">
      <div class="menu-content">
        <ul>
          <li><a href="../index.html">
              <span style="font-weight:900">Home</span>
            </a>
          </li>
        </ul>
    	
    	</div>
      </div>
    <div class="main parent">
      <div class="main parent content">
        <span>Posted on: 2020-06-09, in Category: <a href="../programming.html">programming</a>, tags: <a href='../tags/python.html'>python</a>, <a href='../tags/functional_programming.html'>functional_programming</a>, <a href='../tags/ref-man.html'>ref-man</a>, <a href='../tags/arxiv.html'>arxiv</a>, <a href='../tags/research.html'>research</a></span>
	<h1 align="center">A Python Functional Programming Example</h1>
<p>So I was working on my <a href="https://github.com/akshaybadola/ref-man">ref-man</a> emacs package and I had made some additions which incorporate a local python flask server running on it which fetches data from from <a href="https://dblp.uni-trier.de">dblp API</a>, <a href="https://arxiv.org/help/api/">arXiv API</a> and also Iâ€™m adding <a href="https://api.semanticscholar.org">semantic scholar</a> support. Originally there was only dblp calls so I had to modify the functions and I took a functional programming approach, by generating partial functions and using them to modify the existing code as I modified my existing implementation.</p>
<p>The old dblp function was <code>dblp_old</code> which is still in the file</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">def</span> dblp_old():</span>
<span id="cb1-2"><a href="#cb1-2"></a>    <span class="co"># checking request</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(request.json, <span class="bu">str</span>):</span>
<span id="cb1-4"><a href="#cb1-4"></a>        data <span class="op">=</span> request.json</span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="cf">else</span>:</span>
<span id="cb1-6"><a href="#cb1-6"></a>        <span class="cf">try</span>:</span>
<span id="cb1-7"><a href="#cb1-7"></a>            data <span class="op">=</span> json.loads(request.json)</span>
<span id="cb1-8"><a href="#cb1-8"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb1-9"><a href="#cb1-9"></a>            <span class="cf">return</span> json.dumps(<span class="st">&quot;BAD REQUEST&quot;</span>)</span>
<span id="cb1-10"><a href="#cb1-10"></a>    j <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>    content <span class="op">=</span> {}</span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a>    <span class="co"># The requests are fetched in parallel in batches which can be configured</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb1-15"><a href="#cb1-15"></a>        _data <span class="op">=</span> data[(args.batch_size <span class="op">*</span> j): (args.batch_size <span class="op">*</span> (j <span class="op">+</span> <span class="dv">1</span>))].copy()</span>
<span id="cb1-16"><a href="#cb1-16"></a>        <span class="cf">for</span> k, v <span class="kw">in</span> content.items():</span>
<span id="cb1-17"><a href="#cb1-17"></a>            <span class="cf">if</span> v <span class="op">==</span> [<span class="st">&quot;ERROR&quot;</span>]:</span>
<span id="cb1-18"><a href="#cb1-18"></a>                _data.append(k)</span>
<span id="cb1-19"><a href="#cb1-19"></a>        <span class="cf">if</span> <span class="kw">not</span> _data:</span>
<span id="cb1-20"><a href="#cb1-20"></a>            <span class="cf">break</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>        q <span class="op">=</span> Queue()</span>
<span id="cb1-22"><a href="#cb1-22"></a>        threads <span class="op">=</span> []</span>
<span id="cb1-23"><a href="#cb1-23"></a>        <span class="cf">for</span> d <span class="kw">in</span> _data:</span>
<span id="cb1-24"><a href="#cb1-24"></a>            threads.append(Thread(target<span class="op">=</span>dblp_fetch, args<span class="op">=</span>[d, q],</span>
<span id="cb1-25"><a href="#cb1-25"></a>                                  kwargs<span class="op">=</span>{<span class="st">&quot;verbose&quot;</span>: args.verbose}))</span>
<span id="cb1-26"><a href="#cb1-26"></a>            threads[<span class="op">-</span><span class="dv">1</span>].start()</span>
<span id="cb1-27"><a href="#cb1-27"></a>        <span class="cf">for</span> t <span class="kw">in</span> threads:</span>
<span id="cb1-28"><a href="#cb1-28"></a>            t.join()</span>
<span id="cb1-29"><a href="#cb1-29"></a>        content.update(_dblp_helper_old(q))</span>
<span id="cb1-30"><a href="#cb1-30"></a>        j <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-31"><a href="#cb1-31"></a>    <span class="cf">return</span> json.dumps(content)</span></code></pre></div>
<p>So a function <code>dblp_fetch</code> is given to the threads with the data and a queue as <code>args</code>. All itâ€™ll do is push responses to HTTP requests on to the queue and a helper function <code>_helper</code> will process the results after fetching from the queue.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">def</span> _helper(q):</span>
<span id="cb2-2"><a href="#cb2-2"></a>    content <span class="op">=</span> {}</span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="cf">while</span> <span class="kw">not</span> q.empty():</span>
<span id="cb2-4"><a href="#cb2-4"></a>        query, response <span class="op">=</span> q.get()</span>
<span id="cb2-5"><a href="#cb2-5"></a>        <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb2-6"><a href="#cb2-6"></a>            result <span class="op">=</span> json.loads(response.content)[<span class="st">&quot;result&quot;</span>]</span>
<span id="cb2-7"><a href="#cb2-7"></a>            <span class="cf">if</span> result <span class="kw">and</span> <span class="st">&quot;hits&quot;</span> <span class="kw">in</span> result <span class="kw">and</span> <span class="st">&quot;hit&quot;</span> <span class="kw">in</span> result[<span class="st">&quot;hits&quot;</span>]:</span>
<span id="cb2-8"><a href="#cb2-8"></a>                content[query] <span class="op">=</span> []</span>
<span id="cb2-9"><a href="#cb2-9"></a>                <span class="cf">for</span> hit <span class="kw">in</span> result[<span class="st">&quot;hits&quot;</span>][<span class="st">&quot;hit&quot;</span>]:</span>
<span id="cb2-10"><a href="#cb2-10"></a>                    info <span class="op">=</span> hit[<span class="st">&quot;info&quot;</span>]</span>
<span id="cb2-11"><a href="#cb2-11"></a>                    authors <span class="op">=</span> info[<span class="st">&quot;authors&quot;</span>][<span class="st">&quot;author&quot;</span>]</span>
<span id="cb2-12"><a href="#cb2-12"></a>                    <span class="cf">if</span> <span class="bu">isinstance</span>(authors, <span class="bu">list</span>):</span>
<span id="cb2-13"><a href="#cb2-13"></a>                        info[<span class="st">&quot;authors&quot;</span>] <span class="op">=</span> [x[<span class="st">&quot;text&quot;</span>] <span class="cf">for</span> x <span class="kw">in</span> info[<span class="st">&quot;authors&quot;</span>][<span class="st">&quot;author&quot;</span>]]</span>
<span id="cb2-14"><a href="#cb2-14"></a>                    <span class="cf">else</span>:</span>
<span id="cb2-15"><a href="#cb2-15"></a>                        info[<span class="st">&quot;authors&quot;</span>] <span class="op">=</span> [authors[<span class="st">&quot;text&quot;</span>]]</span>
<span id="cb2-16"><a href="#cb2-16"></a>                    content[query].append(info)</span>
<span id="cb2-17"><a href="#cb2-17"></a>            <span class="cf">else</span>:</span>
<span id="cb2-18"><a href="#cb2-18"></a>                content[query] <span class="op">=</span> [<span class="st">&quot;NO_RESULT&quot;</span>]</span>
<span id="cb2-19"><a href="#cb2-19"></a>        <span class="cf">elif</span> response.status_code <span class="op">==</span> <span class="dv">422</span>:</span>
<span id="cb2-20"><a href="#cb2-20"></a>            content[query] <span class="op">=</span> [<span class="st">&quot;NO_RESULT&quot;</span>]</span>
<span id="cb2-21"><a href="#cb2-21"></a>        <span class="cf">else</span>:</span>
<span id="cb2-22"><a href="#cb2-22"></a>            content[query] <span class="op">=</span> [<span class="st">&quot;ERROR&quot;</span>]</span>
<span id="cb2-23"><a href="#cb2-23"></a>    <span class="cf">return</span> content</span></code></pre></div>
<p>Fairly simple as you can see, but now if I want to add more APIs, I either write separate <code>_fetch</code> and <code>_helper</code> functions for each of them or modify the existing interface. Adding new functions is easier and hackier but error prone in the long run because:</p>
<ol type="1">
<li>Youâ€™ll end up copy pasting the code which will lead to errors</li>
<li>Changes in the implementation where that code interacts with the server will have to be replicated across</li>
</ol>
<p>So I changed the functions in three ways:</p>
<ol type="1">
<li><p>Removed the multithreaded part so that the functions is executed parallely and responses handled by <code>_helper</code> for arbitrary functions. I could have used a threadpool or processpool (<a href="https://docs.python.org/3/library/concurrent.futures.html">See</a>), but I already had the threads implementation and it was working fine.</p></li>
<li><p><code>q_helper</code> now takes three functions as parameters in addition to the queue</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">def</span> q_helper(func_success, func_no_result, func_error, q):</span>
<span id="cb3-2"><a href="#cb3-2"></a>    content <span class="op">=</span> {}</span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="cf">while</span> <span class="kw">not</span> q.empty():</span>
<span id="cb3-4"><a href="#cb3-4"></a>        query, response <span class="op">=</span> q.get()</span>
<span id="cb3-5"><a href="#cb3-5"></a>        <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb3-6"><a href="#cb3-6"></a>            func_success(query, response, content)</span>
<span id="cb3-7"><a href="#cb3-7"></a>        <span class="cf">elif</span> response.status_code <span class="op">==</span> <span class="dv">422</span>:</span>
<span id="cb3-8"><a href="#cb3-8"></a>            func_no_result(query, response, content)</span>
<span id="cb3-9"><a href="#cb3-9"></a>        <span class="cf">else</span>:</span>
<span id="cb3-10"><a href="#cb3-10"></a>            func_error(query, response, content)</span>
<span id="cb3-11"><a href="#cb3-11"></a>    <span class="cf">return</span> content</span></code></pre></div>
<p>So itâ€™s entirely indpendent of whether we fetch from dblp or arxiv or any other source. It doesnâ€™t even handle any of the responses itself but passes them on to the functions. Data is shared with the <code>dict</code> <code>content</code>. But that leaves us with a tiny problem: the <code>helper</code> function in <code>post_json_wrapper</code> only takes the <code>q</code> as an argument while our new <code>q_helper</code> requires 3 functions <em>and</em> the <code>q</code>.</p></li>
<li><p>Now there are two ways to handle that: we can either pass all the functions to the <code>post_json_wrapper</code> or pass a new function which already has the three functions set. After all there will be a separate helper for each API. So this is where the final piece of the functional puzzle falls in.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>_dblp_helper <span class="op">=</span> partial(q_helper, _dblp_success, _dblp_no_result, _dblp_error)</span></code></pre></div>
<p>what weâ€™re doing is defining a new function composed of existing functions <code>q_helper</code>, <code>_dblp_success</code> etc. but with everything but the <code>q</code> already set. <code>arxiv_helper</code> is defined similarly and results in fewer paramters being sent to <code>post_json_wrapper</code> which is <em>almost always</em> a good thing. See <a href="https://docs.python.org/3/library/functools.html">functools</a> module for information about <code>partial</code>.</p></li>
</ol>
<p>So weâ€™ve moved from an API specific threaded function and helper to an API agnostic one while still keeping the original ideas of the implementation intact! Pretty neat! I might write about how functional programming can help reduce software complexity in another post, as even though it looks complex you should keep in mind that most of the functions are stateless. They donâ€™t change over time. That leaves us with fewer things to worry about.</p>
      </div>
    </div>

      <!-- <div class="row banner footer"> -->
      <!-- Include author and date -->
      <!-- 	 <p class="author">Akshay Badola</p>  -->
      <!-- 	 <p class="date">2020-06-09</p>  -->
      <!-- </div> -->

    
    <!-- <script type="text/javascript" src="settings/blog/assets/js/jquery-3.3.1.js"></script> -->
      <!-- <script type="text/javascript" src="../assets/js/bootstrap.min.js"></script> -->
      <script type="text/javascript">document.onload=backrefs();</script>
  </body>
</html>
